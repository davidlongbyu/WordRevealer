<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Wordle Helper</title>

<script src="solutions.js"></script>
<script src="allowed.js"></script>

<style>
  :root {
    --gray:#787c7e;
    --yellow:#c9b458;
    --green:#6aaa64;
    --bg:#f5f5f5;
  }

  body {
    margin:0;
    padding:1rem 1rem 7rem;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background:var(--bg);
  }

  h1 { text-align:center; }

  .guess-row {
    display:flex;
    justify-content:center;
    gap:.4rem;
    margin-bottom:.75rem;
  }

  .tile {
    width:3rem;
    height:3rem;
    border-radius:6px;
    background:var(--gray);
    color:white;
    font-size:1.4rem;
    font-weight:bold;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
  }

  .state-0 { background:var(--gray); }
  .state-1 { background:var(--yellow); }
  .state-2 { background:var(--green); }

  button {
    width:100%;
    padding:.75rem;
    font-size:1rem;
    border-radius:6px;
    border:none;
    background:#333;
    color:white;
  }

  .words {
    margin-top:1rem;
    background:white;
    border-radius:6px;
    max-height:35vh;
    overflow-y:auto;
  }

  .word {
    padding:.5rem;
    text-align:center;
    border-bottom:1px solid #eee;
    font-size:1.1rem;
  }

  .keyboard {
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#ddd;
    padding:.5rem;
  }

  .key-row {
    display:flex;
    justify-content:center;
    gap:.25rem;
    margin-bottom:.25rem;
  }

  .key {
    flex:1;
    padding:.6rem 0;
    background:#999;
    color:white;
    border-radius:4px;
    text-align:center;
    font-weight:bold;
    user-select:none;
  }

  .key.wide { flex:1.5; }
  .key.state-0 { background:var(--gray); }
  .key.state-1 { background:var(--yellow); }
  .key.state-2 { background:var(--green); }
</style>
</head>

<body>

<h1>
  Wordle Helper
  <span id="version"
        style="font-size:0.6em; font-weight:normal; color:#666;">
  </span>
</h1>

<div id="guess" class="guess-row"></div>
<button onclick="applyGuess()">Enter</button>

<label style="display:block;text-align:center;margin-top:.5rem;">
  <input type="checkbox" id="solutionsOnly">
  Show only possible solutions
</label>

<div class="words" id="wordList"></div>

<div class="keyboard">
  <div class="key-row">Q W E R T Y U I O P</div>
  <div class="key-row">A S D F G H J K L</div>
  <div class="key-row">
    <div class="key wide">⌫</div>
    Z X C V B N M
    <div class="key wide">⏎</div>
  </div>
</div>

<script>
let candidates = [];
let guess = Array(5).fill("");
let states = Array(5).fill(0);
let cursor = 0;
const keyState = {};
const APP_VERSION = "0.0.3";

const constraints = {
  greens:Array(5).fill(null),
  yellows:Array.from({length:5},()=>new Set()),
  minCount:{},
  maxCount:{}
};

function ready() {
  Promise.all([window.ALLOWED_LOADED, window.SOLUTIONS_LOADED]).then(() => {
    candidates = [...ALLOWED];
    drawGuess();
    render();
    renderVersion();   // now guaranteed to run after fetches
  }).catch(err => console.error("Failed to load word lists", err));
}

function renderVersion() {
  const el = document.getElementById("version");
  if (el) {
    el.textContent = `Version ${APP_VERSION}`;
  }
}

function drawGuess() {
  const row = document.getElementById("guess");
  row.innerHTML = "";
  guess.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className=`tile state-${states[i]}`;
    d.textContent=c;
    d.onclick=()=>cycle(i,d);
    row.appendChild(d);
  });
}

function cycle(i,el){
  if(!guess[i])return;
  states[i]=(states[i]+1)%3;
  el.className=`tile state-${states[i]}`;
}

function typeLetter(l){
  if(cursor<5){
    guess[cursor]=l;
    cursor++;
    drawGuess();
  }
}

function backspace(){
  if(cursor>0){
    cursor--;
    guess[cursor]="";
    states[cursor]=0;
    drawGuess();
  }
}

function applyGuess(){
  if(guess.some(c=>!c))return;
  processGuess();
  candidates=candidates.filter(matches);
  render();
  guess=Array(5).fill("");
  states=Array(5).fill(0);
  cursor=0;
  drawGuess();
}

function processGuess() {
  // Count green + yellow letters in this guess
  const temp = {};
  guess.forEach((l, i) => {
    if (states[i] > 0) temp[l] = (temp[l] || 0) + 1;
  });

  guess.forEach((l, i) => {
    const s = states[i];

    if (s === 2) { // green
      constraints.greens[i] = l;
      // Ensure minCount accounts for all green+yellow occurrences in this guess
      constraints.minCount[l] = Math.max(constraints.minCount[l] || 0, temp[l]);
    } 
    else if (s === 1) { // yellow
      constraints.yellows[i].add(l);
      // Yellow letters must appear at least once (or more if repeated)
      constraints.minCount[l] = Math.max(constraints.minCount[l] || 0, temp[l]);
    } 
    else if (s === 0) { // gray
      // Gray means "total occurrences in solution ≤ green+yellow count this guess"
      const limit = temp[l] || 0; // if this letter was yellow/green elsewhere, keep that count
      if (constraints.maxCount[l] === undefined) {
        constraints.maxCount[l] = limit;
      } else {
        constraints.maxCount[l] = Math.min(constraints.maxCount[l], limit);
      }
    }

    // Update keyboard color state
    keyState[l] = Math.max(keyState[l] || 0, s);
  });
  
  updateKeyboard();
}

function matches(word) {
  const cnt = {}; // count letters in candidate word

  // Check green and yellow constraints
  for (let i = 0; i < 5; i++) {
    const w = word[i];
    const g = constraints.greens[i];
    const ySet = constraints.yellows[i];

    // Green: must match exactly
    if (g && w !== g) return false;

    // Yellow: letter must NOT be in this position
    if (ySet.has(w)) return false;

    // Count letters for min/max checks
    cnt[w] = (cnt[w] || 0) + 1;
  }

  // Check min counts
  for (const l in constraints.minCount) {
    if ((cnt[l] || 0) < constraints.minCount[l]) return false;
  }

  // Check max counts
  for (const l in constraints.maxCount) {
    if ((cnt[l] || 0) > constraints.maxCount[l]) return false;
  }

  return true; // candidate word passes all constraints
}

function render() {
  const list = document.getElementById("wordList");
  list.innerHTML = "";

  // Ensure word lists are loaded before rendering
  if (!ALLOWED.length || !SOLUTIONS.length) return;

  const solutionsOnly = document.getElementById("solutionsOnly").checked;

  candidates
    .filter(w => {
      // Filter based on Wordle constraints
      if (!matches(w)) return false;

      // If toggle is checked, only show official solutions
      if (solutionsOnly && !SOLUTIONS.includes(w)) return false;

      return true;
    })
    .sort()
    .forEach(w => {
      const d = document.createElement("div");
      d.className = "word";
      d.textContent = w;

      // Clicking fills the guess row
      d.onclick = () => {
        guess = [...w.toUpperCase()];
        cursor = 5;
        drawGuess();
      };

      list.appendChild(d);
    });
}

function updateKeyboard(){
  document.querySelectorAll(".key").forEach(k=>{
    const l=k.textContent;
    if(!/^[A-Z]$/.test(l))return;
    k.classList.remove("state-0","state-1","state-2");
    if(keyState[l]!=null)k.classList.add("state-"+keyState[l]);
  });
}

document.addEventListener("keydown",e=>{
  if(e.key==="Backspace")backspace();
  else if(e.key==="Enter")applyGuess();
  else if(/^[a-zA-Z]$/.test(e.key))typeLetter(e.key.toUpperCase());
});

document.querySelectorAll(".key").forEach(k=>{
  k.onclick=()=>{
    if(k.textContent==="⌫")backspace();
    else if(k.textContent==="⏎")applyGuess();
    else typeLetter(k.textContent);
  };
});

ready();
</script>
</body>
</html>
